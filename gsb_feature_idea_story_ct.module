<?php
/**
 * @file
 * Code for the GSB Feature Idea Story Content Type feature.
 */

include_once 'gsb_feature_idea_story_ct.features.inc';

/**
 * Implements hook_form_FORM_ID_alter() for event node edit form.
 */
function gsb_feature_idea_story_ct_form_idea_story_node_form_alter(&$form, &$form_state, $form_id) {

  if ($form_id != 'idea_story_node_form') {
    return;
  }

  $language = $form['language']['#value'];

  $form['field_link_key_audio']['#states'] = array(
    'visible' => array(
      ':input[name="field_icon[' . $language . ']"]' => array(
        array('value' => 'audio'),
      ),
    ),
  );

  $form['field_link_key_video']['#states'] = array(
    'visible' => array(
      ':input[name="field_icon[' . $language . ']"]' => array(
        array('value' => 'video'),
      ),
    ),
  );

  $form['#after_build'][] = 'gsb_feature_idea_story_ct_after_build';

}

/**
 * gsb_feature_idea_story_ct_after_build()
 *
 * Adds the js needed for replace the key taxonomy select field with
 * our hierarchy lite select field.
 */
function gsb_feature_idea_story_ct_after_build($form, &$form_state) {
  $form['field_link_unlimited']['und']['#title'] = 'Link Title';
  $form['field_link_unlimited']['und'][0]['title']['#title'] = 'Link Title';
  return $form;
}

/**
 * Implements hook_date_popup_process_alter().
 */
function gsb_feature_idea_story_ct_date_popup_process_alter(&$element, &$form_state, $context) {
  if ($form_state['build_info']['form_id'] != 'idea_story_node_form') {
    return;
  }
  if (isset($element['#field']['field_name']) && $element['#field']['field_name'] == 'field_date') {
    $element['date']['#description'] = '';
  }
}

/**
 * Implements hook_field_widget_WIDGET_TYPE_form_alter().
 */
function gsb_feature_idea_story_ct_field_widget_entityreference_autocomplete_form_alter(&$element, &$form_state, $context) {
  if ($form_state['build_info']['form_id'] != 'idea_story_node_form') {
    return;
  }
  if (isset($element['target_id']['#field_name']) && $element['target_id']['#field_name'] == 'field_person_fac_ref') {
    $element['target_id']['#title'] = 'Faculty Name';
    $element['target_id']['#title_display'] = 'before';
  }
  if (isset($element['target_id']['#field_name']) && $element['target_id']['#field_name'] == 'field_related_idea_story') {
    $element['target_id']['#title'] = 'Existing Node Title';
    $element['target_id']['#title_display'] = 'before';
  }
  if (isset($element['target_id']['#field_name']) && $element['target_id']['#field_name'] == 'field_related_other_content') {
    $element['target_id']['#title'] = 'Existing Node Title';
    $element['target_id']['#title_display'] = 'before';
  }
  if (isset($element['target_id']['#field_name']) && $element['target_id']['#field_name'] == 'field_related_events') {
    $element['target_id']['#title'] = 'Existing Node Title';
    $element['target_id']['#title_display'] = 'before';
  }
}
/**
 * Implements hook_field_extra_fields().
 */
function gsb_feature_idea_story_ct_field_extra_fields() {
  $extra['field_collection_item']['field_related_other_unlimited']['display']['related_content_label'] = array(
    'label' => t('Related content entity: Title'),
    'description' => t('Title from referenced entity field.'),
    'weight' => 1,
  );

  return $extra;
}

/**
 * Implements hook_entity_view().
 *
 *  - Render referenced entity title from 'field_related_other' field as an extra field.
 */
function gsb_feature_idea_story_ct_entity_view($entity, $type, $view_mode, $langcode) {
  if ($type == 'field_collection_item' && $entity->field_name == 'field_related_other_unlimited') {
    $wrapper = entity_metadata_wrapper($type, $entity);

    if ($wrapper->field_related_other_content->value()) {
      // Add extra field that displays referenced entity title.
      $entity->content['related_content_label'] = array(
        '#theme' => 'link',
        '#path' => 'node/' . $wrapper->field_related_other_content->getIdentifier(),
        '#text' => $wrapper->field_related_other_content->label(),
        '#prefix' => '<h3>',
        '#suffix' => '</h3>',
        '#options' => array(
          'attributes' => array(
            'class' => array('field-name-field-title'),
            ),
          'html' => FALSE,
        ),
      );
    }
  }
}
